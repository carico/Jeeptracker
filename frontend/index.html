<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jeepney Tracker</title>

<!-- Figma CSS -->
<link rel="stylesheet" href="style.css">

<!-- MapLibre CSS -->
<link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet"/>

<style>
/* Map container */
#map { width: 100%; height: 60vh; border-radius: 12px; margin-bottom: 10px; }
.driver-marker { background:#FF7F50; color:#fff; padding:4px 6px; border-radius:4px; font-weight:bold; text-align:center; cursor:pointer; }
.popup-content { font-family:'Arial', sans-serif; font-size:14px; line-height:1.3; }
.role-section { margin:10px 0; padding:10px; background:#f9f9f9; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
input, button { margin:5px 2px; padding:6px 10px; border-radius:5px; border:1px solid #ccc; }
button { background:#FF7F50; color:#fff; border:none; cursor:pointer; }
button:hover { background:#e06b3f; }
@media(max-width:600px){ #map{height:50vh;} }
</style>
</head>
<body>

<!-- === Login / Signup UI === -->
<div id="user-ui" class="role-section">
    <h2>Login / Signup</h2>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button id="signup">Sign Up</button>
    <button id="login">Login</button>
</div>

<!-- === Logged-in UI === -->
<div id="loggedin" style="display:none;">
    <div class="role-section">
        <button id="logout">Logout</button>
        <h3>Balance: ₱<span id="balance-amt">0.00</span></h3>
    </div>

    <!-- Map -->
    <div id="map-container">
        <div id="map" style="width:100%; height:500px;"></div>
    </div>

    <!-- Passenger Controls -->
    <div id="passenger-controls" class="role-section" style="display:none;">
        <h4>Calculate Route / Fare</h4>
        <input id="dest-lat" type="number" placeholder="Destination Latitude" step="0.000001">
        <input id="dest-lng" type="number" placeholder="Destination Longitude" step="0.000001">
        <button id="calc">Calculate Route</button>
        <button id="pay">Pay Fare</button>
        <p id="fare-result"></p>
    </div>

    <!-- Driver/Admin Controls -->
    <div id="driver-controls" class="role-section" style="display:none;">
        <h4>Driver Management</h4>
        <input id="driver-id" type="text" placeholder="Driver ID">
        <input id="driver-name" type="text" placeholder="Driver Name">
        <input id="driver-lat" type="number" placeholder="Latitude" step="0.000001">
        <input id="driver-lng" type="number" placeholder="Longitude" step="0.000001">
        <button id="add-driver">Add Driver</button>
        <button id="update-driver">Update Driver</button>
        <button id="delete-driver">Delete Driver</button>
    </div>
</div>

<!-- Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
<script src="firebase-config.js"></script>

<script src="app.js"></script>
<script>
/* === Role-based UI and map initialization === */
const markers = {};
const polylines = {};
let map;
const backendBase = 'http://localhost:8000';

auth.onAuthStateChanged(async (user) => {
    if(user){
        const tokenResult = await user.getIdTokenResult();
        const role = tokenResult.claims.role || "passenger";
        window.userRole = role;

        document.getElementById('user-ui').style.display='none';
        document.getElementById('loggedin').style.display='block';
        document.getElementById('passenger-controls').style.display = (role==="passenger")?"block":"none";
        document.getElementById('driver-controls').style.display = (role==="driver")?"block":"none";

        initMap();

        if(role==="passenger") startFetchingJeepsETA();
        else if(role==="driver") startUpdatingDriverLocation(user.uid);
    } else {
        document.getElementById('user-ui').style.display='block';
        document.getElementById('loggedin').style.display='none';
    }
});

/* === Login / Signup / Logout === */
document.getElementById('signup').onclick = async ()=>{
    const email = document.getElementById('email').value;
    const pass = document.getElementById('password').value;
    try{ await auth.createUserWithEmailAndPassword(email, pass); alert('Signed up'); }
    catch(e){ alert(e.message); }
};

document.getElementById('login').onclick = async ()=>{
    const email = document.getElementById('email').value;
    const pass = document.getElementById('password').value;
    try{ await auth.signInWithEmailAndPassword(email, pass); }
    catch(e){ alert(e.message); }
};

document.getElementById('logout').onclick = ()=>auth.signOut();

/* === Map + Markers === */
function initMap(){
    if(map) return;
    map = new maplibregl.Map({
        container:'map',
        style:'https://demotiles.maplibre.org/style.json',
        center:[121.0437,14.6760],
        zoom:13
    });
    map.addControl(new maplibregl.NavigationControl());

    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            const coords = [pos.coords.longitude, pos.coords.latitude];
            map.setCenter(coords);
            map.setZoom(15);
            new maplibregl.Marker({color:'#FF0000'})
                .setLngLat(coords)
                .setPopup(new maplibregl.Popup({offset:25}).setText("You are here"))
                .addTo(map);
        });
    }
}

function addOrUpdateMarker(id, loc, popupHTML=null){
    if(!map) return;
    const coords = [loc.lng, loc.lat];
    if(markers[id]){
        markers[id].setLngLat(coords);
        if(popupHTML) markers[id].setPopup(new maplibregl.Popup({offset:25}).setHTML(popupHTML));
    } else {
        const el = document.createElement('div');
        el.className='driver-marker';
        el.innerText='J';
        el.style.background='#FF7F50';
        el.style.color='#fff';
        el.style.fontWeight='bold';
        el.style.padding='4px 6px';
        el.style.borderRadius='4px';
        el.style.textAlign='center';
        el.style.cursor='pointer';

        const marker = new maplibregl.Marker(el)
            .setLngLat(coords)
            .addTo(map);
        if(popupHTML) marker.setPopup(new maplibregl.Popup({offset:25}).setHTML(popupHTML));
        markers[id]=marker;
    }
}

/* === Passenger: Fetch ETA + Routes === */
async function fetchJeepsWithETA(userLat,userLng){
    const user = auth.currentUser;
    if(!user) return;
    const token = await user.getIdToken();
    const res = await fetch(`${backendBase}/drivers_with_eta?user_lat=${userLat}&user_lng=${userLng}`,{
        headers:{ "Authorization":`Bearer ${token}` }
    });
    if(!res.ok) return;
    const jeeps = await res.json();
    Object.keys(jeeps).forEach(jeepId=>{
        const jeep = jeeps[jeepId];
        const popupHTML = `Jeep ID: ${jeepId}<br>Distance: ${jeep.distance_km} km<br>ETA: ${jeep.eta_minutes} min
            <br><button onclick="drawRoute('${jeepId}')">Show Route</button>`;
        addOrUpdateMarker(jeepId,{lat:jeep.lat,lng:jeep.lng},popupHTML);
        polylines[jeepId]=jeep.geometry.map(c=>[c[1],c[0]]);
    });
}

function startFetchingJeepsETA(){
    if(!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude, lng=pos.coords.longitude;
        fetchJeepsWithETA(lat,lng);
        setInterval(()=>fetchJeepsWithETA(lat,lng),5000);
    });
}

function drawRoute(jeepId){
    if(!map||!polylines[jeepId]) return;
    const coords = polylines[jeepId];
    const layerId = `route-${jeepId}`;
    if(map.getSource(layerId)){ map.removeLayer(layerId); map.removeSource(layerId);}
    map.addSource(layerId,{ type:'geojson', data:{type:'Feature',geometry:{type:'LineString',coordinates:coords}}});
    map.addLayer({id:layerId,type:'line',source:layerId,layout:{'line-join':'round','line-cap':'round'},paint:{'line-color':'#FF4500','line-width':4,'line-opacity':0.8}});
    const bounds=coords.reduce((b,c)=>b.extend(c),new maplibregl.LngLatBounds(coords[0],coords[0]));
    map.fitBounds(bounds,{padding:30});
}

/* === Driver: Update own location === */
function startUpdatingDriverLocation(driverId){
    if(!navigator.geolocation) return;
    navigator.geolocation.watchPosition(pos=>{
        const loc={lat:pos.coords.latitude,lng:pos.coords.longitude};
        rtdb.ref(`drivers/${driverId}/location`).set(loc);
        addOrUpdateMarker(driverId,loc);
    },err=>console.warn("Geo error:",err),{enableHighAccuracy:true});
}

/* === Driver CRUD buttons === */
document.getElementById('add-driver').onclick = async ()=>{
    const id = document.getElementById('driver-id').value;
    const name = document.getElementById('driver-name').value;
    const lat = parseFloat(document.getElementById('driver-lat').value);
    const lng = parseFloat(document.getElementById('driver-lng').value);
    if(!id||!name||isNaN(lat)||isNaN(lng)) return alert('Fill all fields');

    const token = await auth.currentUser.getIdToken();
    const res = await fetch(`${backendBase}/drivers`,{
        method:'POST',
        headers:{ "Content-Type":"application/json","Authorization":`Bearer ${token}`},
        body:JSON.stringify({id,name,lat,lng})
    });
    if(!res.ok) return alert(`Error: ${res.status}`);
    alert('Driver added');
};

document.getElementById('update-driver').onclick = async ()=>{
    const id = document.getElementById('driver-id').value;
    const name = document.getElementById('driver-name').value;
    const lat = parseFloat(document.getElementById('driver-lat').value);
    const lng = parseFloat(document.getElementById('driver-lng').value);
    if(!id||!name||isNaN(lat)||isNaN(lng)) return alert('Fill all fields');

    const token = await auth.currentUser.getIdToken();
    const res = await fetch(`${backendBase}/drivers/${id}`,{
        method:'PUT',
        headers:{ "Content-Type":"application/json","Authorization":`Bearer ${token}`},
        body:JSON.stringify({id,name,lat,lng})
    });
    if(!res.ok) return alert(`Error: ${res.status}`);
    alert('Driver updated');
};

document.getElementById('delete-driver').onclick = async ()=>{
    const id = document.getElementById('driver-id').value;
    if(!id) return alert('Enter driver ID');

    const token = await auth.currentUser.getIdToken();
    const res = await fetch(`${backendBase}/drivers/${id}`,{
        method:'DELETE',
        headers:{ "Authorization":`Bearer ${token}` }
    });
    if(!res.ok) return alert(`Error: ${res.status}`);
    alert('Driver deleted');
};

/* === Fare Calculation & Balance === */
document.getElementById('calc').onclick = async ()=>{
    const destLat = parseFloat(document.getElementById('dest-lat').value);
    const destLng = parseFloat(document.getElementById('dest-lng').value);
    if(isNaN(destLat)||isNaN(destLng)) return alert("Enter valid coordinates");

    const start = map.getCenter();
    const startLat = start.lat, startLng = start.lng;

    const user = auth.currentUser;
    if(!user) return alert("Login first");
    const token = await user.getIdToken();

    const res = await fetch(`${backendBase}/route?start_lat=${startLat}&start_lng=${startLng}&end_lat=${destLat}&end_lng=${destLng}`,{
        headers:{ "Authorization":`Bearer ${token}` }
    });
    if(!res.ok) return alert(`Error: ${res.status}`);
    const data = await res.json();

    const geojson = { type:'Feature', geometry:{ type:'LineString', coordinates:data.geometry.map(([lat,lng])=>[lng,lat]) } };
    if(map.getSource('route')){ map.removeLayer('route'); map.removeSource('route'); }
    map.addSource('route',{type:'geojson',data:geojson});
    map.addLayer({id:'route',type:'line',source:'route',layout:{'line-join':'round','line-cap':'round'},paint:{'line-color':'#1E90FF','line-width':5,'line-opacity':0.8}});

    const bounds = data.geometry.reduce((b,c)=>b.extend([c[1],c[0]]), new maplibregl.LngLatBounds([data.geometry[0][1],data.geometry[0][0]],[data.geometry[0][1],data.geometry[0][0]]));
    map.fitBounds(bounds,{padding:30});

    document.getElementById('fare-result').innerText = `Distance: ${data.distance_km} km | Duration: ${Math.round(data.duration_s/60)} min | Fare: ₱${data.fare_php}`;
    window.lastRouteFare = data.fare_php;
};

document.getElementById('pay').onclick = async ()=>{
    const user = auth.currentUser;
    if(!user) return alert("Login first");
    const uid = user.uid;
    if(!window.lastRouteFare) return alert("Calculate route first");
    const balRef = rtdb.ref(`users/${uid}/balance`);
    const snap = await balRef.get();
    const bal = (snap.exists() && snap.val()) ? snap.val() : 0;
    if(bal < window.lastRouteFare) return alert("Insufficient balance");
    balRef.set(bal-window.lastRouteFare);
    alert(`Paid ₱${window.lastRouteFare.toFixed(2)}`);
};

/* === Load balance realtime === */
auth.onAuthStateChanged(user=>{
    if(!user) return;
    const balRef = rtdb.ref(`users/${user.uid}/balance`);
    balRef.on('value',snap=>{
        document.getElementById('balance-amt').innerText = (snap.val()||0).toFixed(2);
    });
});
</script>
</body>
</html>
